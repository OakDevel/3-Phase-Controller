/* 
 * File:   ThreePhaseController.cpp
 * Author: Cameron
 * 
 * Created on October 22, 2015, 2:21 AM
 */

#include <avr/pgmspace.h>
#include <util/atomic.h>
#include <util/delay.h>

#include "ThreePhaseController.h"
#include "MLX90363.h"
#include "ThreePhaseDriver.h"
#include "Debug.h"
#include "Interpreter.h"
#include "Predictor.h"

bool ThreePhaseController::isForwardTorque;
u1 ThreePhaseController::magRoll;

void TIMER4_OVF_vect() {
 ThreePhaseController::isr();
}

void ThreePhaseController::isr() {
 u1 static mlx = 1;

 // Scale phase to output range
 u2 outputPhase = Predictor::predict();

 // Offset from current angle by 90deg for max torque
 if (isForwardTorque) outputPhase += ThreePhaseDriver::StepsPerCycle / 4;
 else                 outputPhase -= ThreePhaseDriver::StepsPerCycle / 4;
 
 // Fix outputPhase range
 if (outputPhase > ThreePhaseDriver::StepsPerCycle) {
  // Fix it
  if (isForwardTorque) outputPhase -= ThreePhaseDriver::StepsPerCycle;
  else                 outputPhase += ThreePhaseDriver::StepsPerCycle;
 }
 
 // Update driver outputs
 ThreePhaseDriver::advanceTo(outputPhase);
 
 // Don't continue if we're not done counting down
 if (--mlx)
  return;
 
 MLX90363::startTransmitting();
 
 mlx = cyclesPWMPerMLX;
}

//size of table in program memory
u2 constexpr loop = 4097;

/**
 * 12-bit lookup table for magnetometer Alpha value to Phase value
 */
static const u2 AlphaToPhaseLookup[loop] PROGMEM = {
 // Table generated with python on calibration branch
 0x6156,0x6154,0x6153,0x6151,0x6150,0x614e,0x614c,0x614b,0x6149,0x6147,0x6144,0x6143,0x6140,0x613e,0x613d,0x613b,0x6139,0x6138,0x6136,0x6135,
 0x6133,0x6131,0x6130,0x612e,0x612c,0x612a,0x6129,0x6128,0x6126,0x6124,0x6123,0x6120,0x611f,0x611d,0x611a,0x6119,0x6116,0x6114,0x6112,0x6110,
 0x610e,0x610b,0x6109,0x6107,0x6103,0x6100,0x60fb,0x60f8,0x60f7,0x60f5,0x60f3,0x60f2,0x60f1,0x60ef,0x60ee,0x60ed,0x60ec,0x60eb,0x60ea,0x60e9,
 0x60e9,0x60e8,0x60e7,0x60e6,0x60e6,0x60e5,0x60e5,0x60e4,0x60e3,0x60e2,0x60e1,0x60e0,0x60df,0x60dd,0x60dc,0x60db,0x60d9,0x60d8,0x60d6,0x60d4,
 0x60d3,0x60d0,0x60ce,0x60cc,0x60c9,0x60c7,0x60c4,0x60c2,0x60c0,0x60bd,0x60ba,0x60b8,0x60b5,0x60b3,0x60b1,0x60af,0x60ad,0x60ab,0x60a9,0x60a7,
 0x60a5,0x60a3,0x60a1,0x609f,0x609d,0x609b,0x6099,0x6097,0x6095,0x6092,0x6090,0x608e,0x608d,0x608b,0x608a,0x6087,0x6086,0x6084,0x6081,0x607e,
 0x607c,0x607a,0x6078,0x6077,0x6075,0x6073,0x6072,0x6070,0x606f,0x606e,0x606c,0x606b,0x606a,0x6069,0x6069,0x6068,0x6068,0x6067,0x6067,0x6067,
 0x6066,0x6066,0x6066,0x6065,0x6065,0x6065,0x6064,0x6064,0x6063,0x6062,0x6061,0x6060,0x605f,0x605f,0x605d,0x605d,0x605b,0x6059,0x6059,0x6058,
 0x6056,0x6054,0x6052,0x6050,0x604e,0x604c,0x604b,0x6048,0x6046,0x6044,0x6042,0x6040,0x603e,0x603b,0x6039,0x6037,0x6035,0x6033,0x6031,0x6030,
 0x602d,0x602c,0x602a,0x6028,0x6027,0x6026,0x6023,0x6023,0x6021,0x6020,0x601e,0x601d,0x601b,0x601a,0x6019,0x6017,0x6016,0x6014,0x6012,0x6011,
 0x600f,0x600e,0x600c,0x600a,0x6009,0x6008,0x6006,0x6005,0x6000,0x52fd,0x52fa,0x52f9,0x52f8,0x52f7,0x52f5,0x52f5,0x52f3,0x52f3,0x52f2,0x52f1,
 0x52f0,0x52f0,0x52ef,0x52ee,0x52ee,0x52ed,0x52ed,0x52ed,0x52ed,0x52ec,0x52ec,0x52ec,0x52eb,0x52ea,0x52ea,0x52e9,0x52e9,0x52e8,0x52e7,0x52e6,
 0x52e6,0x52e5,0x52e5,0x52e4,0x52e3,0x52e1,0x52e0,0x52df,0x52de,0x52dd,0x52db,0x52da,0x52d8,0x52d7,0x52d6,0x52d4,0x52d3,0x52d0,0x52cf,0x52cd,
 0x52cb,0x52c9,0x52c8,0x52c5,0x52c4,0x52c2,0x52c0,0x52bf,0x52bd,0x52bb,0x52ba,0x52b8,0x52b7,0x52b5,0x52b4,0x52b2,0x52b1,0x52b0,0x52ae,0x52ae,
 0x52ac,0x52ab,0x52aa,0x52a8,0x52a7,0x52a6,0x52a6,0x52a4,0x52a3,0x52a2,0x52a2,0x52a1,0x529f,0x529e,0x529d,0x529c,0x529b,0x529a,0x5299,0x5298,
 0x5297,0x5295,0x5293,0x5292,0x5291,0x5290,0x528e,0x528d,0x528b,0x528a,0x5289,0x5287,0x5286,0x5284,0x5282,0x5281,0x527f,0x527d,0x527c,0x527a,
 0x5279,0x5277,0x5277,0x5275,0x5275,0x5273,0x5272,0x5271,0x5270,0x5270,0x526e,0x526d,0x526b,0x526b,0x5269,0x5269,0x5268,0x5267,0x5266,0x5265,
 0x5264,0x5263,0x5262,0x5261,0x5261,0x5260,0x525f,0x525e,0x525d,0x525c,0x525b,0x525a,0x5259,0x5258,0x5257,0x5256,0x5254,0x5253,0x5252,0x5250,
 0x524f,0x524e,0x524d,0x524b,0x524a,0x5248,0x5246,0x5245,0x5243,0x5243,0x5240,0x523f,0x523e,0x523d,0x523b,0x523a,0x5239,0x5238,0x5237,0x5235,
 0x5234,0x5233,0x5232,0x5231,0x5230,0x5230,0x522f,0x522d,0x522d,0x522c,0x522b,0x522a,0x5229,0x5229,0x5228,0x5228,0x5228,0x5227,0x5226,0x5225,
 0x5225,0x5224,0x5223,0x5222,0x5222,0x5220,0x5220,0x521f,0x521e,0x521d,0x521c,0x521c,0x521b,0x521a,0x5219,0x5218,0x5217,0x5216,0x5214,0x5214,
 0x5212,0x5211,0x520f,0x520e,0x520c,0x520b,0x5209,0x5208,0x5207,0x5206,0x5200,0x51ff,0x51fa,0x51f9,0x51f8,0x51f7,0x51f5,0x51f4,0x51f2,0x51f1,
 0x51ef,0x51ee,0x51ec,0x51eb,0x51ea,0x51e8,0x51e7,0x51e6,0x51e5,0x51e3,0x51e3,0x51e1,0x51e0,0x51df,0x51df,0x51dd,0x51dd,0x51dc,0x51da,0x51d9,
 0x51d8,0x51d8,0x51d8,0x51d7,0x51d6,0x51d5,0x51d4,0x51d3,0x51d2,0x51d1,0x51d0,0x51cf,0x51cf,0x51ce,0x51cd,0x51cb,0x51cb,0x51ca,0x51c9,0x51c8,
 0x51c8,0x51c7,0x51c6,0x51c5,0x51c4,0x51c4,0x51c2,0x51c2,0x51c0,0x51c0,0x51bf,0x51bd,0x51bd,0x51bc,0x51bb,0x51ba,0x51b8,0x51b8,0x51b7,0x51b6,
 0x51b5,0x51b4,0x51b3,0x51b2,0x51b2,0x51b2,0x51b1,0x51b0,0x51b0,0x51af,0x51af,0x51af,0x51ae,0x51ae,0x51ad,0x51ad,0x51ad,0x51ac,0x51ac,0x51ac,
 0x51ab,0x51ab,0x51aa,0x51aa,0x51a9,0x51a9,0x51a9,0x51a9,0x51a8,0x51a8,0x51a7,0x51a7,0x51a6,0x51a6,0x51a6,0x51a5,0x51a4,0x51a3,0x51a2,0x51a1,
 0x51a1,0x51a0,0x519f,0x519d,0x519c,0x519b,0x519b,0x5199,0x5198,0x5197,0x5195,0x5194,0x5192,0x5190,0x518e,0x518e,0x518c,0x518b,0x5189,0x5188,
 0x5187,0x5185,0x5184,0x5182,0x517f,0x517e,0x517c,0x517a,0x5179,0x5178,0x5177,0x5176,0x5175,0x5173,0x5172,0x5171,0x5170,0x516f,0x516e,0x516c,
 0x516b,0x516a,0x5169,0x5168,0x5168,0x5167,0x5166,0x5166,0x5165,0x5165,0x5164,0x5164,0x5163,0x5162,0x5161,0x5160,0x515f,0x515f,0x515f,0x515e,
 0x515d,0x515c,0x515b,0x515a,0x515a,0x5159,0x5158,0x5157,0x5156,0x5156,0x5154,0x5154,0x5152,0x5152,0x5150,0x5150,0x514f,0x514d,0x514d,0x514b,
 0x514b,0x514a,0x5149,0x5148,0x5146,0x5145,0x5144,0x5143,0x5143,0x5142,0x5141,0x5140,0x5140,0x513f,0x513e,0x513d,0x513d,0x513c,0x513b,0x513b,
 0x513a,0x513a,0x513a,0x5139,0x5138,0x5137,0x5137,0x5137,0x5135,0x5135,0x5133,0x5133,0x5132,0x5131,0x5130,0x5130,0x512f,0x512e,0x512d,0x512c,
 0x512b,0x512a,0x5128,0x5128,0x5126,0x5125,0x5123,0x5123,0x5120,0x511f,0x511d,0x511c,0x511a,0x5119,0x5117,0x5115,0x5113,0x5111,0x510f,0x510e,
 0x510c,0x510a,0x5108,0x5107,0x5104,0x5101,0x50fe,0x50fa,0x50f9,0x50f8,0x50f6,0x50f5,0x50f3,0x50f2,0x50f1,0x50ef,0x50ee,0x50ed,0x50ec,0x50ea,
 0x50ea,0x50e8,0x50e7,0x50e6,0x50e5,0x50e5,0x50e3,0x50e2,0x50e1,0x50e0,0x50e0,0x50df,0x50de,0x50dd,0x50dc,0x50dc,0x50da,0x50da,0x50d9,0x50d8,
 0x50d8,0x50d6,0x50d5,0x50d4,0x50d3,0x50d2,0x50d0,0x50cf,0x50ce,0x50cd,0x50cb,0x50ca,0x50c8,0x50c7,0x50c5,0x50c5,0x50c2,0x50c1,0x50c0,0x50be,
 0x50bd,0x50bb,0x50ba,0x50b8,0x50b6,0x50b5,0x50b3,0x50b2,0x50b0,0x50b0,0x50ae,0x50ad,0x50ac,0x50aa,0x50a9,0x50a7,0x50a6,0x50a5,0x50a3,0x50a2,
 0x50a1,0x509f,0x509e,0x509d,0x509b,0x509a,0x5099,0x5098,0x5096,0x5095,0x5092,0x5091,0x5090,0x508e,0x508d,0x508c,0x508b,0x5089,0x5087,0x5085,
 0x5083,0x5081,0x507f,0x507c,0x507a,0x5079,0x5077,0x5075,0x5073,0x5072,0x5070,0x506f,0x506d,0x506b,0x506a,0x5068,0x5067,0x5066,0x5065,0x5065,
 0x5064,0x5063,0x5062,0x5061,0x5060,0x5060,0x505f,0x505f,0x505e,0x505d,0x505d,0x505c,0x505c,0x505b,0x505b,0x505a,0x505a,0x505a,0x5059,0x5059,
 0x5058,0x5058,0x5057,0x5057,0x5056,0x5054,0x5053,0x5053,0x5052,0x5051,0x504f,0x504e,0x504d,0x504b,0x5049,0x5048,0x5046,0x5044,0x5043,0x5041,
 0x503f,0x503d,0x503b,0x5039,0x5038,0x5036,0x5034,0x5033,0x5031,0x502f,0x502d,0x502c,0x502a,0x5029,0x5027,0x5026,0x5024,0x5023,0x5021,0x5020,
 0x501e,0x501d,0x501b,0x501a,0x5019,0x5016,0x5015,0x5013,0x5012,0x5010,0x500f,0x500d,0x500b,0x500a,0x5008,0x5007,0x5006,0x5000,0x42ff,0x42fa,
 0x42f9,0x42f8,0x42f7,0x42f6,0x42f4,0x42f3,0x42f2,0x42f1,0x42f0,0x42f0,0x42f0,0x42f0,0x42ef,0x42ef,0x42ef,0x42ee,0x42ee,0x42ee,0x42ee,0x42ee,
 0x42ee,0x42ed,0x42ed,0x42ed,0x42ec,0x42ec,0x42eb,0x42eb,0x42ea,0x42e9,0x42e8,0x42e7,0x42e6,0x42e5,0x42e4,0x42e3,0x42e1,0x42e0,0x42dd,0x42dc,
 0x42da,0x42d8,0x42d6,0x42d3,0x42d2,0x42cf,0x42cd,0x42cb,0x42c8,0x42c5,0x42c4,0x42c1,0x42bf,0x42bc,0x42ba,0x42b8,0x42b6,0x42b4,0x42b2,0x42b0,
 0x42ae,0x42ac,0x42aa,0x42a8,0x42a7,0x42a5,0x42a4,0x42a2,0x42a1,0x429f,0x429d,0x429c,0x429a,0x4298,0x4297,0x4295,0x4293,0x4291,0x428f,0x428e,
 0x428c,0x428a,0x4288,0x4287,0x4285,0x4282,0x4280,0x427f,0x427c,0x427a,0x4279,0x4278,0x4278,0x4277,0x4276,0x4275,0x4274,0x4274,0x4272,0x4272,
 0x4271,0x4270,0x426f,0x426e,0x426c,0x426b,0x426a,0x4269,0x4267,0x4266,0x4264,0x4262,0x4261,0x425f,0x425c,0x425a,0x4258,0x4256,0x4253,0x4251,
 0x424e,0x424b,0x4248,0x4246,0x4243,0x4240,0x423e,0x423b,0x4239,0x4237,0x4234,0x4232,0x4230,0x422e,0x422b,0x422a,0x4228,0x4226,0x4224,0x4222,
 0x4220,0x421e,0x421d,0x421b,0x4219,0x4217,0x4216,0x4214,0x4212,0x4210,0x420e,0x420c,0x420b,0x4208,0x4207,0x4204,0x4200,0x41fb,0x41f8,0x41f7,
 0x41f5,0x41f2,0x41f1,0x41ee,0x41ec,0x41ea,0x41e8,0x41e7,0x41e5,0x41e3,0x41e1,0x41e0,0x41de,0x41dd,0x41db,0x41da,0x41d8,0x41d8,0x41d6,0x41d5,
 0x41d3,0x41d3,0x41d1,0x41d0,0x41cf,0x41cd,0x41cc,0x41ca,0x41c9,0x41c8,0x41c6,0x41c5,0x41c3,0x41c1,0x41c0,0x41be,0x41bc,0x41ba,0x41b8,0x41b6,
 0x41b4,0x41b2,0x41b0,0x41af,0x41ae,0x41ac,0x41ab,0x41aa,0x41a8,0x41a8,0x41a7,0x41a6,0x41a5,0x41a4,0x41a3,0x41a2,0x41a1,0x41a1,0x41a0,0x419f,
 0x419e,0x419d,0x419c,0x419b,0x419b,0x419a,0x4199,0x4198,0x4197,0x4195,0x4194,0x4192,0x4190,0x418e,0x418c,0x418b,0x4189,0x4187,0x4185,0x4182,
 0x417f,0x417c,0x417a,0x4179,0x4177,0x4175,0x4174,0x4172,0x4171,0x416f,0x416e,0x416c,0x416a,0x4169,0x4168,0x4167,0x4166,0x4165,0x4164,0x4163,
 0x4161,0x4160,0x415f,0x415e,0x415d,0x415c,0x415a,0x4159,0x4158,0x4156,0x4155,0x4153,0x4152,0x4151,0x414f,0x414e,0x414d,0x414b,0x414a,0x4148,
 0x4146,0x4145,0x4143,0x4142,0x4141,0x4140,0x413f,0x413e,0x413d,0x413d,0x413c,0x413b,0x413a,0x413a,0x413a,0x4139,0x4139,0x4138,0x4137,0x4137,
 0x4137,0x4136,0x4135,0x4134,0x4134,0x4132,0x4132,0x4130,0x4130,0x412e,0x412d,0x412c,0x412a,0x4129,0x4127,0x4126,0x4123,0x4121,0x4120,0x411d,
 0x411b,0x4119,0x4116,0x4114,0x4112,0x410f,0x410d,0x410a,0x4108,0x4107,0x4102,0x4100,0x40fa,0x40f8,0x40f7,0x40f5,0x40f4,0x40f2,0x40f0,0x40ee,
 0x40ed,0x40eb,0x40ea,0x40e8,0x40e6,0x40e5,0x40e4,0x40e3,0x40e1,0x40e0,0x40df,0x40dd,0x40dd,0x40db,0x40da,0x40d8,0x40d8,0x40d6,0x40d5,0x40d3,
 0x40d2,0x40d0,0x40cf,0x40ce,0x40cd,0x40cb,0x40c9,0x40c8,0x40c7,0x40c6,0x40c5,0x40c3,0x40c2,0x40c0,0x40bf,0x40bd,0x40bc,0x40bb,0x40ba,0x40b8,
 0x40b7,0x40b6,0x40b5,0x40b3,0x40b3,0x40b2,0x40b1,0x40b0,0x40af,0x40ae,0x40ad,0x40ac,0x40ab,0x40aa,0x40a9,0x40a7,0x40a7,0x40a5,0x40a4,0x40a2,
 0x40a1,0x40a0,0x409e,0x409d,0x409b,0x409a,0x4098,0x4096,0x4095,0x4092,0x4090,0x408e,0x408d,0x408b,0x408a,0x4087,0x4085,0x4083,0x4080,0x407e,
 0x407c,0x4079,0x4077,0x4076,0x4074,0x4072,0x4070,0x406f,0x406d,0x406b,0x4069,0x4068,0x4067,0x4065,0x4064,0x4063,0x4061,0x4060,0x405f,0x405e,
 0x405c,0x405b,0x405a,0x405a,0x4059,0x4058,0x4057,0x4057,0x4056,0x4054,0x4053,0x4053,0x4052,0x4052,0x4051,0x4050,0x404f,0x404f,0x404e,0x404d,
 0x404c,0x404a,0x404a,0x4049,0x4048,0x4047,0x4046,0x4045,0x4043,0x4042,0x4041,0x4040,0x403e,0x403d,0x403c,0x403b,0x403a,0x4039,0x4038,0x4037,
 0x4036,0x4035,0x4033,0x4032,0x4031,0x4030,0x402f,0x402d,0x402d,0x402b,0x402a,0x402a,0x4029,0x4028,0x4027,0x4026,0x4025,0x4023,0x4023,0x4022,
 0x4020,0x401f,0x401e,0x401d,0x401c,0x401b,0x4019,0x4018,0x4017,0x4016,0x4015,0x4014,0x4012,0x4011,0x4010,0x400f,0x400d,0x400c,0x400a,0x4009,
 0x4008,0x4007,0x4006,0x4002,0x4000,0x32fb,0x32fa,0x32f9,0x32f8,0x32f6,0x32f4,0x32f3,0x32f1,0x32f0,0x32ef,0x32ee,0x32ed,0x32ec,0x32eb,0x32ea,
 0x32e9,0x32e8,0x32e8,0x32e7,0x32e6,0x32e6,0x32e6,0x32e6,0x32e6,0x32e5,0x32e5,0x32e5,0x32e5,0x32e5,0x32e4,0x32e4,0x32e4,0x32e3,0x32e3,0x32e3,
 0x32e3,0x32e3,0x32e2,0x32e2,0x32e2,0x32e1,0x32e1,0x32e0,0x32e0,0x32df,0x32df,0x32df,0x32de,0x32de,0x32dd,0x32dc,0x32dc,0x32db,0x32da,0x32d9,
 0x32d8,0x32d8,0x32d7,0x32d6,0x32d5,0x32d3,0x32d3,0x32d1,0x32d0,0x32cf,0x32cd,0x32cc,0x32ca,0x32c9,0x32c8,0x32c6,0x32c5,0x32c4,0x32c2,0x32c1,
 0x32bf,0x32be,0x32bd,0x32bb,0x32ba,0x32b8,0x32b8,0x32b6,0x32b5,0x32b3,0x32b3,0x32b1,0x32b0,0x32af,0x32ae,0x32ad,0x32ac,0x32aa,0x32a9,0x32a8,
 0x32a7,0x32a6,0x32a5,0x32a3,0x32a3,0x32a1,0x32a0,0x329f,0x329e,0x329d,0x329c,0x329a,0x3299,0x3298,0x3297,0x3295,0x3295,0x3293,0x3291,0x3290,
 0x328f,0x328e,0x328d,0x328c,0x328b,0x3289,0x3289,0x3287,0x3286,0x3285,0x3284,0x3283,0x3282,0x3281,0x327f,0x327e,0x327d,0x327c,0x327b,0x327b,
 0x327a,0x3279,0x3278,0x3278,0x3278,0x3278,0x3277,0x3277,0x3277,0x3276,0x3276,0x3275,0x3275,0x3275,0x3274,0x3274,0x3274,0x3274,0x3273,0x3273,
 0x3273,0x3272,0x3272,0x3272,0x3271,0x3271,0x3271,0x3270,0x3270,0x326f,0x326e,0x326e,0x326d,0x326c,0x326b,0x326a,0x3269,0x3269,0x3267,0x3267,
 0x3265,0x3265,0x3263,0x3262,0x3261,0x325f,0x325e,0x325d,0x325b,0x3259,0x3259,0x3256,0x3255,0x3253,0x3251,0x3250,0x324f,0x324d,0x324b,0x3249,
 0x3247,0x3246,0x3243,0x3242,0x3240,0x323f,0x323d,0x323b,0x323a,0x3239,0x3237,0x3235,0x3234,0x3233,0x3230,0x3230,0x322d,0x322c,0x322b,0x3229,
 0x3228,0x3227,0x3226,0x3224,0x3223,0x3221,0x3220,0x321f,0x321d,0x321c,0x321b,0x3219,0x3219,0x3217,0x3216,0x3214,0x3213,0x3212,0x3210,0x320f,
 0x320e,0x320c,0x320b,0x320a,0x3208,0x3208,0x3206,0x3206,0x3201,0x3200,0x31fd,0x31fa,0x31f9,0x31f8,0x31f7,0x31f6,0x31f5,0x31f4,0x31f2,0x31f1,
 0x31f0,0x31ef,0x31ee,0x31ed,0x31ec,0x31eb,0x31ea,0x31e9,0x31e9,0x31e8,0x31e7,0x31e6,0x31e6,0x31e5,0x31e5,0x31e5,0x31e4,0x31e3,0x31e2,0x31e2,
 0x31e1,0x31e0,0x31e0,0x31df,0x31df,0x31dd,0x31dd,0x31dc,0x31db,0x31da,0x31d9,0x31d8,0x31d8,0x31d7,0x31d6,0x31d5,0x31d3,0x31d3,0x31d1,0x31d0,
 0x31cf,0x31ce,0x31cc,0x31cb,0x31c9,0x31c8,0x31c6,0x31c5,0x31c3,0x31c2,0x31c0,0x31be,0x31bd,0x31bb,0x31b9,0x31b8,0x31b6,0x31b4,0x31b3,0x31b1,
 0x31b0,0x31af,0x31ad,0x31ac,0x31aa,0x31aa,0x31a8,0x31a7,0x31a5,0x31a5,0x31a3,0x31a2,0x31a1,0x319f,0x319f,0x319d,0x319c,0x319b,0x319a,0x3199,
 0x3198,0x3197,0x3196,0x3195,0x3193,0x3192,0x3190,0x318f,0x318e,0x318e,0x318d,0x318b,0x318a,0x3189,0x3188,0x3187,0x3186,0x3184,0x3183,0x3181,
 0x317f,0x317d,0x317c,0x317a,0x3179,0x3177,0x3177,0x3175,0x3175,0x3174,0x3172,0x3172,0x3170,0x316f,0x316e,0x316d,0x316b,0x316b,0x3169,0x3169,
 0x3168,0x3167,0x3166,0x3166,0x3165,0x3165,0x3164,0x3163,0x3162,0x3161,0x3160,0x315f,0x315f,0x315e,0x315d,0x315b,0x315b,0x3159,0x3159,0x3158,
 0x3156,0x3156,0x3154,0x3153,0x3152,0x3150,0x3150,0x314e,0x314d,0x314b,0x3149,0x3148,0x3146,0x3144,0x3143,0x3141,0x3140,0x313e,0x313d,0x313b,
 0x313a,0x3139,0x3138,0x3137,0x3136,0x3135,0x3134,0x3133,0x3132,0x3132,0x3131,0x3130,0x3130,0x312f,0x312e,0x312d,0x312c,0x312c,0x312b,0x312a,
 0x312a,0x3129,0x3129,0x3128,0x3127,0x3126,0x3125,0x3124,0x3123,0x3121,0x3120,0x311f,0x311d,0x311c,0x311a,0x3119,0x3116,0x3115,0x3112,0x3110,
 0x310f,0x310c,0x310a,0x3108,0x3106,0x3102,0x3100,0x30fb,0x30f9,0x30f8,0x30f6,0x30f4,0x30f2,0x30f1,0x30ee,0x30ed,0x30ec,0x30ea,0x30e8,0x30e7,
 0x30e5,0x30e3,0x30e2,0x30e0,0x30e0,0x30de,0x30dd,0x30db,0x30da,0x30d8,0x30d7,0x30d6,0x30d3,0x30d2,0x30d0,0x30ce,0x30cd,0x30cb,0x30c9,0x30c8,
 0x30c6,0x30c5,0x30c3,0x30c2,0x30c0,0x30bf,0x30bd,0x30bc,0x30bb,0x30b9,0x30b8,0x30b7,0x30b6,0x30b5,0x30b4,0x30b3,0x30b2,0x30b2,0x30b1,0x30b0,
 0x30af,0x30ae,0x30ae,0x30ad,0x30ac,0x30aa,0x30a9,0x30a8,0x30a7,0x30a6,0x30a5,0x30a3,0x30a2,0x30a0,0x309e,0x309c,0x309a,0x3099,0x3096,0x3093,
 0x3091,0x308e,0x308c,0x308a,0x3087,0x3085,0x3081,0x307e,0x307b,0x3079,0x3076,0x3074,0x3072,0x3070,0x306e,0x306b,0x3069,0x3067,0x3065,0x3063,
 0x3061,0x3060,0x305e,0x305d,0x305b,0x3059,0x3059,0x3057,0x3055,0x3054,0x3053,0x3052,0x3050,0x304f,0x304e,0x304d,0x304b,0x304a,0x3049,0x3047,
 0x3045,0x3043,0x3042,0x3041,0x303f,0x303d,0x303c,0x303b,0x3039,0x3038,0x3037,0x3036,0x3034,0x3033,0x3032,0x3031,0x3030,0x302f,0x302d,0x302c,
 0x302b,0x302a,0x3029,0x3028,0x3026,0x3025,0x3023,0x3021,0x3020,0x301d,0x301c,0x301a,0x3018,0x3015,0x3013,0x3010,0x300e,0x300b,0x3009,0x3007,
 0x3000,0x22ff,0x22f9,0x22f7,0x22f5,0x22f2,0x22f1,0x22ee,0x22ec,0x22eb,0x22e9,0x22e7,0x22e6,0x22e5,0x22e4,0x22e3,0x22e1,0x22e0,0x22df,0x22de,
 0x22dd,0x22dc,0x22da,0x22d9,0x22d8,0x22d8,0x22d7,0x22d6,0x22d4,0x22d3,0x22d2,0x22d0,0x22cf,0x22ce,0x22cc,0x22cb,0x22c9,0x22c7,0x22c5,0x22c3,
 0x22c2,0x22c0,0x22bd,0x22bc,0x22ba,0x22b8,0x22b7,0x22b5,0x22b3,0x22b1,0x22b0,0x22ae,0x22ad,0x22ab,0x22a9,0x22a7,0x22a6,0x22a4,0x22a2,0x22a0,
 0x229f,0x229c,0x229a,0x2299,0x2296,0x2294,0x2291,0x228f,0x228d,0x228b,0x2289,0x2286,0x2284,0x2281,0x227f,0x227c,0x227a,0x2278,0x2277,0x2275,
 0x2273,0x2272,0x2271,0x2270,0x226f,0x226d,0x226c,0x226b,0x226a,0x226a,0x2269,0x2268,0x2268,0x2267,0x2267,0x2266,0x2265,0x2265,0x2264,0x2263,
 0x2262,0x2261,0x2260,0x225f,0x225d,0x225c,0x225a,0x2259,0x2257,0x2255,0x2253,0x2251,0x224f,0x224d,0x224b,0x2249,0x2246,0x2243,0x2242,0x223f,
 0x223c,0x223b,0x2238,0x2236,0x2233,0x2231,0x222f,0x222d,0x222a,0x2229,0x2227,0x2225,0x2223,0x2220,0x221f,0x221d,0x221b,0x2219,0x2217,0x2215,
 0x2213,0x2211,0x220f,0x220d,0x220b,0x2209,0x2207,0x2206,0x2200,0x21ff,0x21fa,0x21f8,0x21f7,0x21f6,0x21f4,0x21f2,0x21f1,0x21f0,0x21ee,0x21ee,
 0x21ed,0x21ec,0x21eb,0x21ea,0x21e9,0x21e9,0x21e8,0x21e8,0x21e7,0x21e6,0x21e6,0x21e6,0x21e5,0x21e5,0x21e5,0x21e4,0x21e3,0x21e2,0x21e2,0x21e1,
 0x21e0,0x21df,0x21de,0x21dd,0x21dd,0x21db,0x21da,0x21d9,0x21d8,0x21d7,0x21d6,0x21d4,0x21d2,0x21d0,0x21cf,0x21cc,0x21cb,0x21c8,0x21c6,0x21c4,
 0x21c2,0x21c1,0x21bf,0x21bd,0x21bb,0x21b9,0x21b7,0x21b5,0x21b3,0x21b1,0x21b0,0x21ae,0x21ac,0x21ab,0x21a9,0x21a7,0x21a6,0x21a4,0x21a2,0x21a1,
 0x219f,0x219d,0x219b,0x219a,0x2199,0x2198,0x2196,0x2195,0x2193,0x2191,0x218f,0x218e,0x218d,0x218b,0x218a,0x2189,0x2188,0x2187,0x2185,0x2183,
 0x2181,0x217f,0x217c,0x217b,0x2179,0x2178,0x2178,0x2177,0x2176,0x2175,0x2175,0x2174,0x2174,0x2173,0x2173,0x2172,0x2172,0x2171,0x2171,0x2170,
 0x216f,0x216f,0x216e,0x216d,0x216d,0x216c,0x216b,0x216a,0x2169,0x2169,0x2168,0x2167,0x2166,0x2166,0x2165,0x2164,0x2163,0x2161,0x2160,0x215f,
 0x215d,0x215c,0x215b,0x2159,0x2158,0x2156,0x2155,0x2153,0x2151,0x2150,0x214d,0x214c,0x214a,0x2148,0x2146,0x2145,0x2143,0x2141,0x213f,0x213e,
 0x213c,0x213b,0x2139,0x2138,0x2137,0x2135,0x2134,0x2133,0x2131,0x2130,0x212f,0x212d,0x212c,0x212b,0x212a,0x2128,0x2128,0x2126,0x2125,0x2124,
 0x2123,0x2122,0x2120,0x2120,0x211e,0x211d,0x211c,0x211b,0x211a,0x2119,0x2118,0x2116,0x2115,0x2114,0x2113,0x2111,0x2110,0x210f,0x210e,0x210c,
 0x210b,0x2109,0x2108,0x2107,0x2106,0x2104,0x2100,0x20fb,0x20fa,0x20f9,0x20f8,0x20f7,0x20f5,0x20f4,0x20f3,0x20f2,0x20f1,0x20f0,0x20ee,0x20ed,
 0x20ec,0x20ec,0x20ea,0x20ea,0x20e8,0x20e7,0x20e6,0x20e5,0x20e5,0x20e3,0x20e3,0x20e2,0x20e0,0x20e0,0x20de,0x20dd,0x20dd,0x20db,0x20da,0x20d9,
 0x20d8,0x20d8,0x20d6,0x20d6,0x20d4,0x20d3,0x20d1,0x20d0,0x20cf,0x20cd,0x20cc,0x20ca,0x20c9,0x20c8,0x20c6,0x20c5,0x20c4,0x20c2,0x20c1,0x20c0,
 0x20be,0x20bd,0x20bc,0x20ba,0x20b9,0x20b8,0x20b6,0x20b5,0x20b3,0x20b3,0x20b2,0x20b0,0x20af,0x20ae,0x20ae,0x20ad,0x20ab,0x20aa,0x20a9,0x20a9,
 0x20a8,0x20a7,0x20a6,0x20a6,0x20a6,0x20a5,0x20a4,0x20a3,0x20a2,0x20a2,0x20a2,0x20a1,0x20a1,0x20a0,0x209f,0x209f,0x209e,0x209d,0x209c,0x209c,
 0x209b,0x209b,0x209a,0x2099,0x2098,0x2097,0x2096,0x2095,0x2093,0x2091,0x2090,0x208f,0x208e,0x208d,0x208b,0x208b,0x2089,0x2088,0x2087,0x2085,
 0x2084,0x2081,0x207f,0x207e,0x207c,0x207a,0x2079,0x2077,0x2077,0x2075,0x2073,0x2072,0x2071,0x2070,0x206e,0x206c,0x206b,0x206a,0x2068,0x2067,
 0x2066,0x2065,0x2064,0x2063,0x2061,0x2061,0x205f,0x205f,0x205e,0x205d,0x205b,0x205b,0x205a,0x2059,0x2058,0x2058,0x2057,0x2056,0x2055,0x2054,
 0x2053,0x2052,0x2051,0x2050,0x2050,0x204f,0x204f,0x204d,0x204d,0x204b,0x204b,0x204a,0x2049,0x2048,0x2046,0x2046,0x2045,0x2043,0x2043,0x2042,
 0x2041,0x2040,0x203f,0x203e,0x203d,0x203d,0x203c,0x203b,0x203b,0x203a,0x203a,0x2039,0x2038,0x2038,0x2038,0x2037,0x2037,0x2036,0x2036,0x2036,
 0x2035,0x2034,0x2034,0x2034,0x2033,0x2033,0x2032,0x2032,0x2032,0x2031,0x2031,0x2030,0x2030,0x202f,0x202f,0x202f,0x202e,0x202d,0x202c,0x202c,
 0x202b,0x202b,0x202a,0x2029,0x2029,0x2028,0x2028,0x2028,0x2026,0x2026,0x2025,0x2024,0x2023,0x2022,0x2021,0x2020,0x201f,0x201e,0x201c,0x201b,
 0x201a,0x2019,0x2017,0x2016,0x2014,0x2013,0x2012,0x2010,0x200f,0x200d,0x200b,0x2009,0x2008,0x2007,0x2006,0x2003,0x2000,0x12fd,0x12fa,0x12f9,
 0x12f8,0x12f8,0x12f6,0x12f5,0x12f4,0x12f2,0x12f1,0x12f1,0x12ef,0x12ee,0x12ed,0x12ec,0x12eb,0x12ea,0x12e9,0x12e8,0x12e7,0x12e6,0x12e5,0x12e5,
 0x12e4,0x12e3,0x12e2,0x12e1,0x12e0,0x12df,0x12df,0x12de,0x12dd,0x12dc,0x12dc,0x12da,0x12d9,0x12d9,0x12d8,0x12d8,0x12d7,0x12d6,0x12d5,0x12d5,
 0x12d3,0x12d3,0x12d1,0x12d1,0x12cf,0x12cf,0x12ce,0x12cd,0x12cb,0x12ca,0x12c9,0x12c8,0x12c7,0x12c6,0x12c5,0x12c4,0x12c4,0x12c3,0x12c2,0x12c0,
 0x12bf,0x12bf,0x12be,0x12bd,0x12bc,0x12bc,0x12bb,0x12bb,0x12ba,0x12b9,0x12b8,0x12b7,0x12b7,0x12b6,0x12b5,0x12b5,0x12b3,0x12b2,0x12b2,0x12b1,
 0x12b0,0x12b0,0x12af,0x12ae,0x12ad,0x12ac,0x12ab,0x12aa,0x12a8,0x12a7,0x12a6,0x12a5,0x12a4,0x12a3,0x12a1,0x12a0,0x129e,0x129d,0x129b,0x1299,
 0x1298,0x1297,0x1295,0x1293,0x1291,0x1290,0x128e,0x128d,0x128b,0x1289,0x1287,0x1286,0x1284,0x1282,0x1280,0x127e,0x127c,0x127a,0x1279,0x1277,
 0x1276,0x1275,0x1273,0x1272,0x1271,0x1270,0x126f,0x126d,0x126c,0x126b,0x126a,0x1269,0x1267,0x1267,0x1266,0x1265,0x1264,0x1263,0x1262,0x1261,
 0x1260,0x125f,0x125f,0x125e,0x125d,0x125c,0x125b,0x125a,0x1259,0x1258,0x1257,0x1256,0x1255,0x1254,0x1253,0x1252,0x1250,0x1250,0x124e,0x124d,
 0x124b,0x124a,0x1249,0x1248,0x1246,0x1244,0x1243,0x1242,0x1240,0x123e,0x123d,0x123c,0x123a,0x1239,0x1238,0x1236,0x1235,0x1233,0x1232,0x1230,
 0x122f,0x122d,0x122c,0x122a,0x122a,0x1228,0x1227,0x1226,0x1225,0x1223,0x1222,0x1220,0x121f,0x121e,0x121c,0x121b,0x121a,0x1218,0x1216,0x1215,
 0x1214,0x1212,0x1210,0x120f,0x120d,0x120b,0x1209,0x1208,0x1206,0x1203,0x1200,0x11fc,0x11f9,0x11f8,0x11f7,0x11f5,0x11f3,0x11f1,0x11ef,0x11ee,
 0x11ed,0x11ea,0x11ea,0x11e7,0x11e6,0x11e5,0x11e4,0x11e3,0x11e1,0x11e1,0x11df,0x11df,0x11de,0x11dd,0x11dc,0x11dc,0x11dc,0x11db,0x11db,0x11da,
 0x11da,0x11d9,0x11d9,0x11d9,0x11d9,0x11d8,0x11d8,0x11d7,0x11d6,0x11d6,0x11d6,0x11d5,0x11d4,0x11d3,0x11d2,0x11d2,0x11d0,0x11d0,0x11ce,0x11cd,
 0x11cb,0x11ca,0x11c8,0x11c7,0x11c5,0x11c4,0x11c2,0x11c0,0x11bf,0x11bd,0x11bc,0x11ba,0x11b8,0x11b6,0x11b4,0x11b2,0x11b0,0x11af,0x11ad,0x11ab,
 0x11a9,0x11a8,0x11a7,0x11a5,0x11a3,0x11a2,0x11a0,0x119f,0x119d,0x119b,0x119a,0x1199,0x1197,0x1195,0x1194,0x1192,0x1191,0x118e,0x118e,0x118c,
 0x118b,0x1189,0x1188,0x1187,0x1185,0x1183,0x1181,0x117f,0x117d,0x117c,0x1179,0x1178,0x1178,0x1177,0x1177,0x1176,0x1176,0x1175,0x1175,0x1175,
 0x1174,0x1174,0x1174,0x1174,0x1173,0x1173,0x1173,0x1172,0x1172,0x1172,0x1171,0x1171,0x1170,0x116f,0x116e,0x116d,0x116d,0x116c,0x116b,0x116a,
 0x1169,0x1168,0x1167,0x1166,0x1165,0x1164,0x1162,0x1161,0x115f,0x115d,0x115b,0x1159,0x1156,0x1154,0x1152,0x1150,0x114e,0x114b,0x1149,0x1147,
 0x1144,0x1142,0x1140,0x113e,0x113c,0x113a,0x1138,0x1136,0x1134,0x1132,0x1130,0x112e,0x112c,0x112a,0x1129,0x1127,0x1126,0x1123,0x1122,0x1120,
 0x111d,0x111c,0x111a,0x1118,0x1116,0x1114,0x1112,0x1110,0x110f,0x110c,0x110a,0x1108,0x1107,0x1105,0x1100,0x10fe,0x10fa,0x10f9,0x10f8,0x10f7,
 0x10f6,0x10f5,0x10f4,0x10f3,0x10f2,0x10f1,0x10f0,0x10ef,0x10ee,0x10ed,0x10ec,0x10ea,0x10e9,0x10e7,0x10e7,0x10e5,0x10e4,0x10e3,0x10e0,0x10df,
 0x10dd,0x10da,0x10d9,0x10d6,0x10d4,0x10d2,0x10d0,0x10cd,0x10ca,0x10c8,0x10c6,0x10c3,0x10c1,0x10be,0x10bc,0x10b9,0x10b6,0x10b4,0x10b1,0x10af,
 0x10ad,0x10ab,0x10a9,0x10a7,0x10a5,0x10a3,0x10a1,0x109f,0x109d,0x109c,0x109a,0x1099,0x1097,0x1095,0x1092,0x1091,0x108e,0x108e,0x108c,0x108b,
 0x1089,0x1087,0x1084,0x1082,0x107f,0x107c,0x107a,0x1078,0x1076,0x1075,0x1072,0x1070,0x106f,0x106c,0x106a,0x1068,0x1067,0x1065,0x1063,0x1061,
 0x1060,0x105f,0x105e,0x105c,0x105b,0x105a,0x1059,0x1057,0x1056,0x1054,0x1053,0x1052,0x1051,0x1050,0x104e,0x104d,0x104b,0x104a,0x1048,0x1046,
 0x1045,0x1043,0x1041,0x103f,0x103d,0x103b,0x103a,0x1038,0x1037,0x1035,0x1034,0x1032,0x1031,0x1030,0x102e,0x102d,0x102c,0x102a,0x1029,0x1029,
 0x1028,0x1028,0x1027,0x1026,0x1025,0x1025,0x1024,0x1023,0x1022,0x1022,0x1021,0x1020,0x101f,0x101d,0x101d,0x101b,0x101a,0x1019,0x1017,0x1016,
 0x1014,0x1012,0x1010,0x100e,0x100c,0x100a,0x1008,0x1006,0x1001,0x02fe,0x02fa,0x02f8,0x02f7,0x02f5,0x02f3,0x02f1,0x02f0,0x02ee,0x02ed,0x02eb,
 0x02ea,0x02e9,0x02e7,0x02e6,0x02e5,0x02e3,0x02e2,0x02e1,0x02df,0x02de,0x02dd,0x02db,0x02da,0x02d9,0x02d8,0x02d7,0x02d6,0x02d5,0x02d3,0x02d2,
 0x02d1,0x02cf,0x02ce,0x02cd,0x02cb,0x02ca,0x02c8,0x02c7,0x02c6,0x02c5,0x02c3,0x02c2,0x02c1,0x02c0,0x02bf,0x02be,0x02bd,0x02bc,0x02bc,0x02bb,
 0x02bb,0x02ba,0x02b9,0x02b8,0x02b7,0x02b7,0x02b6,0x02b5,0x02b4,0x02b3,0x02b2,0x02b2,0x02b0,0x02b0,0x02af,0x02ae,0x02ac,0x02ab,0x02aa,0x02a8,
 0x02a7,0x02a6,0x02a4,0x02a3,0x02a1,0x029f,0x029d,0x029b,0x0299,0x0297,0x0295,0x0292,0x0290,0x028e,0x028c,0x028a,0x0287,0x0285,0x0282,0x0280,
 0x027d,0x027b,0x0279,0x0278,0x0276,0x0275,0x0272,0x0272,0x0270,0x026e,0x026d,0x026b,0x0269,0x0268,0x0267,0x0265,0x0264,0x0263,0x0261,0x0260,
 0x025f,0x025d,0x025c,0x025b,0x0259,0x0258,0x0256,0x0254,0x0253,0x0252,0x0250,0x024f,0x024d,0x024b,0x024a,0x0248,0x0246,0x0245,0x0243,0x0242,
 0x0240,0x023f,0x023e,0x023c,0x023b,0x023a,0x0239,0x0238,0x0237,0x0236,0x0235,0x0233,0x0232,0x0232,0x0230,0x022f,0x022e,0x022d,0x022c,0x022b,
 0x022a,0x0229,0x0228,0x0227,0x0226,0x0225,0x0223,0x0223,0x0221,0x021f,0x021d,0x021c,0x021b,0x0219,0x0217,0x0215,0x0213,0x0211,0x020f,0x020d,
 0x020b,0x0209,0x0208,0x0206,0x0200,0x01ff,0x01fa,0x01f8,0x01f7,0x01f5,0x01f3,0x01f1,0x01ef,0x01ed,0x01eb,0x01ea,0x01e7,0x01e6,0x01e5,0x01e3,
 0x01e1,0x01e0,0x01de,0x01dd,0x01dc,0x01db,0x01da,0x01d9,0x01d8,0x01d8,0x01d7,0x01d6,0x01d5,0x01d5,0x01d4,0x01d3,0x01d2,0x01d1,0x01d1,0x01d0,
 0x01cf,0x01cf,0x01ce,0x01cd,0x01cb,0x01cb,0x01ca,0x01ca,0x01c8,0x01c7,0x01c7,0x01c5,0x01c5,0x01c4,0x01c3,0x01c2,0x01c0,0x01bf,0x01be,0x01bd,
 0x01bc,0x01bb,0x01b9,0x01b8,0x01b7,0x01b6,0x01b5,0x01b3,0x01b2,0x01b1,0x01b0,0x01af,0x01ae,0x01ad,0x01ac,0x01aa,0x01a9,0x01a8,0x01a7,0x01a6,
 0x01a5,0x01a5,0x01a3,0x01a2,0x01a1,0x01a0,0x019f,0x019e,0x019d,0x019c,0x019b,0x019a,0x0199,0x0198,0x0197,0x0196,0x0195,0x0193,0x0191,0x0190,
 0x018f,0x018e,0x018c,0x018b,0x018a,0x0189,0x0188,0x0187,0x0185,0x0184,0x0182,0x017f,0x017d,0x017c,0x017a,0x0179,0x0177,0x0177,0x0176,0x0175,
 0x0174,0x0173,0x0172,0x0171,0x0171,0x0170,0x016e,0x016d,0x016d,0x016c,0x016b,0x016a,0x016a,0x016a,0x0169,0x0169,0x0169,0x0169,0x0168,0x0169,
 0x0168,0x0168,0x0168,0x0167,0x0167,0x0167,0x0167,0x0166,0x0166,0x0166,0x0166,0x0165,0x0165,0x0165,0x0164,0x0164,0x0163,0x0163,0x0162,0x0162,
 0x0161,0x0160,0x0160,0x015f,0x015f,0x015e,0x015d,0x015b,0x015a,0x0159,0x0159,0x0158,0x0156,0x0155,0x0154,0x0152,0x0151,0x0150,0x014e,0x014d,
 0x014b,0x014a,0x0148,0x0147,0x0145,0x0144,0x0143,0x0141,0x0140,0x013e,0x013d,0x013c,0x013b,0x013a,0x0139,0x0138,0x0137,0x0135,0x0134,0x0133,
 0x0131,0x0130,0x012f,0x012d,0x012d,0x012b,0x012a,0x0129,0x0128,0x0127,0x0126,0x0125,0x0123,0x0122,0x0121,0x0120,0x011f,0x011d,0x011c,0x011b,
 0x011a,0x0119,0x0118,0x0116,0x0116,0x0114,0x0113,0x0112,0x0111,0x0110,0x010f,0x010e,0x010c,0x010b,0x010a,0x0108,0x0108,0x0107,0x0106,0x0106,
 0x0102,0x0100,0x00fd,0x00fb,0x00fa,0x00fa,0x00f9,0x00f8,0x00f8,0x00f7,0x00f7,0x00f7,0x00f6,0x00f5,0x00f4,0x00f4,0x00f4,0x00f4,0x00f3,0x00f3,
 0x00f3,0x00f2,0x00f2,0x00f1,0x00f1,0x00f0,0x00f0,0x00f0,0x00ef,0x00ee,0x00ee,0x00ed,0x00ed,0x00ed,0x00ec,0x00eb,0x00eb,0x00ea,0x00e9,0x00e8,
 0x00e7,0x00e7,0x00e6,0x00e5,0x00e4,0x00e3,0x00e2,0x00e0,0x00e0,0x00df,0x00dd,0x00dc,0x00db,0x00d9,0x00d8,0x00d7,0x00d6,0x00d4,0x00d3,0x00d1,
 0x00cf,0x00cd,0x00cc,0x00ca,0x00c8,0x00c7,0x00c5,0x00c4,0x00c2,0x00c0,0x00be,0x00bd,0x00bb,0x00b9,0x00b7,0x00b5,0x00b4,0x00b2,0x00b0,0x00af,
 0x00ae,0x00ac,0x00aa,0x00a9,0x00a7,0x00a7,0x00a5,0x00a4,0x00a2,0x00a1,0x00a0,0x009f,0x009d,0x009c,0x009b,0x0099,0x0098,0x0097,0x0095,0x0094,
 0x0092,0x0090,0x008f,0x008e,0x008d,0x008c,0x008b,0x008a,0x0088,0x0087,0x0085,0x0084,0x0082,0x0080,0x007e,0x007c,0x007b,0x0079,0x0078,0x0077,
 0x0076,0x0075,0x0074,0x0073,0x0072,0x0071,0x0070,0x006f,0x006e,0x006d,0x006c,0x006b,0x006a,0x0069,0x0069,0x0068,0x0067,0x0066,0x0066,0x0066,
 0x0065,0x0065,0x0064,0x0064,0x0063,0x0063,0x0062,0x0061,0x0060,0x0060,0x005f,0x005f,0x005e,0x005d,0x005c,0x005b,0x005a,0x005a,0x0059,0x0058,
 0x0057,0x0056,0x0055,0x0053,0x0052,0x0051,0x0050,0x004e,0x004d,0x004b,0x0049,0x0048,0x0046,0x0045,0x0043,0x0042,0x0040,0x003e,0x003c,0x003b,
 0x003a,0x0038,0x0038,0x0036,0x0034,0x0033,0x0031,0x0030,0x002e,0x002d,0x002c,0x002a,0x0029,0x0028,0x0027,0x0026,0x0025,0x0023,0x0023,0x0021,
 0x0020,0x0020,0x001e,0x001d,0x001c,0x001b,0x001b,0x0019,0x0019,0x0017,0x0016,0x0015,0x0014,0x0013,0x0012,0x0011,0x0010,0x000f,0x000e,0x000c,
 0x000a,0x0009,0x0008,0x0007,0x0006,0x0002,0x0000,0x62fd,0x62fa,0x62f9,0x62f8,0x62f7,0x62f5,0x62f4,0x62f3,0x62f1,0x62f1,0x62ef,0x62ee,0x62ed,
 0x62ec,0x62eb,0x62ea,0x62e9,0x62e8,0x62e7,0x62e6,0x62e6,0x62e5,0x62e4,0x62e3,0x62e2,0x62e2,0x62e1,0x62e0,0x62df,0x62df,0x62de,0x62dd,0x62dc,
 0x62db,0x62da,0x62d9,0x62d8,0x62d8,0x62d7,0x62d6,0x62d5,0x62d3,0x62d2,0x62d1,0x62d0,0x62ce,0x62cd,0x62cb,0x62c9,0x62c8,0x62c7,0x62c5,0x62c4,
 0x62c3,0x62c1,0x62bf,0x62be,0x62bd,0x62bb,0x62ba,0x62b8,0x62b7,0x62b6,0x62b5,0x62b4,0x62b3,0x62b2,0x62b2,0x62b1,0x62b0,0x62af,0x62af,0x62ae,
 0x62ae,0x62ad,0x62ac,0x62ab,0x62aa,0x62a9,0x62a9,0x62a8,0x62a7,0x62a6,0x62a6,0x62a5,0x62a3,0x62a2,0x62a1,0x62a0,0x629f,0x629d,0x629c,0x629a,
 0x6299,0x6297,0x6295,0x6292,0x6291,0x628e,0x628d,0x628b,0x6289,0x6287,0x6284,0x6282,0x6280,0x627e,0x627c,0x627a,0x6278,0x6277,0x6275,0x6274,
 0x6272,0x6271,0x626f,0x626e,0x626c,0x626a,0x6268,0x6267,0x6266,0x6264,0x6263,0x6261,0x6260,0x625e,0x625d,0x625b,0x6259,0x6259,0x6257,0x6255,
 0x6254,0x6252,0x6250,0x624f,0x624d,0x624b,0x624a,0x6248,0x6246,0x6245,0x6243,0x6241,0x6240,0x623e,0x623c,0x623b,0x623a,0x6238,0x6238,0x6236,
 0x6235,0x6234,0x6233,0x6232,0x6232,0x6231,0x6230,0x622f,0x622e,0x622d,0x622c,0x622b,0x622a,0x6229,0x6228,0x6227,0x6226,0x6224,0x6223,0x6221,
 0x621f,0x621d,0x621b,0x6219,0x6217,0x6215,0x6212,0x620f,0x620d,0x620a,0x6208,0x6205,0x6200,0x61fd,0x61f8,0x61f6,0x61f4,0x61f0,0x61ee,0x61eb,
 0x61e9,0x61e7,0x61e5,0x61e3,0x61e1,0x61df,0x61dd,0x61dc,0x61db,0x61d9,0x61d8,0x61d7,0x61d6,0x61d4,0x61d3,0x61d1,0x61d0,0x61cf,0x61cd,0x61cc,
 0x61ca,0x61c9,0x61c8,0x61c6,0x61c5,0x61c3,0x61c1,0x61bf,0x61bd,0x61bc,0x61ba,0x61b8,0x61b7,0x61b6,0x61b4,0x61b3,0x61b2,0x61b1,0x61b0,0x61ae,
 0x61ae,0x61ad,0x61ac,0x61ab,0x61aa,0x61a9,0x61a8,0x61a7,0x61a6,0x61a5,0x61a3,0x61a2,0x61a0,0x619f,0x619d,0x619b,0x619a,0x6198,0x6195,0x6193,
 0x6191,0x618e,0x618b,0x6189,0x6187,0x6184,0x6181,0x617e,0x617b,0x6179,0x6177,0x6175,0x6173,0x6172,0x616f,0x616d,0x616b,0x616a,0x6168,0x6167,
 0x6166,0x6165,0x6165,0x6164,0x6162,0x6161,0x6160,0x6160,0x615f,0x615e,0x615d,0x615c,0x615b,0x615a,0x6159,0x6157,0x6156,
};

/**
 * Converts the magnetometer to a phase value
 * @param alpha 14-bit value from magnetometer
 * @return phase value (0 - 0x2ff inclusive)
 */
inline static u2 lookupAlphaToPhase(u2 alpha) {
 // Make sure we're working with a 14-bit number
 alpha &= 0x7fff;
 
 //divide alpha by 4 to get a feasible table size
 alpha >>= 2;
 
 //if somehow we get a magnetomiter reading larger then in calibration
 //circle around to begining
 if (alpha > loop){
  alpha -= loop;
 }

 // Read the phase number word from the calculated place in the lookup table
 return pgm_read_word(&AlphaToPhaseLookup[alpha]);
}

void ThreePhaseController::init() {
 MLX90363::init();
 ThreePhaseDriver::init();
 ThreePhaseDriver::setAmplitude(0);
 
 MLX90363::prepareGET1Message(MLX90363::MessageType::Alpha);

 // Enable Timer4 Overflow Interrupt
 TIMSK4 = 1 << TOIE4;
 
 magRoll = MLX90363::getRoll();

 // Get two new readings to get started
 while (!MLX90363::hasNewData(magRoll));
 while (!MLX90363::hasNewData(magRoll));
 
 Predictor::init(lookupAlphaToPhase(MLX90363::getAlpha()));
}

void ThreePhaseController::setTorque(const Torque t) {
 ATOMIC_BLOCK(ATOMIC_FORCEON) {
  isForwardTorque = t.forward;
  ThreePhaseDriver::setAmplitude(t.amplitude);
 }
}

bool ThreePhaseController::updateDriver() {
 if (!MLX90363::hasNewData(magRoll)) return false;
 
 // We can always grab the latest Alpha value safely here
 auto const alpha = MLX90363::getAlpha();
 auto const magPha = lookupAlphaToPhase(alpha);
 
 Predictor::freshPhase(magPha);

 return true;
}
